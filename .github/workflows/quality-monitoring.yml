# Scheduled Quality Monitoring for 20minCoach
# Runs daily quality checks and dependency audits

name: ðŸ“Š Quality Monitoring

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual execution
  workflow_dispatch:

jobs:
  # ðŸ” Daily Quality Audit
  daily-quality-check:
    name: ðŸ“Š Daily Quality Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“² Install dependencies
        run: npm ci
      
      - name: ðŸ” ESLint Analysis
        id: eslint
        run: |
          npm run lint --format=json > eslint-results.json || true
          echo "eslint_errors=$(jq '.[] | select(.errorCount > 0) | .errorCount' eslint-results.json | jq -s 'add // 0')" >> $GITHUB_OUTPUT
          echo "eslint_warnings=$(jq '.[] | select(.warningCount > 0) | .warningCount' eslint-results.json | jq -s 'add // 0')" >> $GITHUB_OUTPUT
      
      - name: ðŸ—ï¸ Build Check
        id: build
        run: |
          if npm run build; then
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "build_status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ§ª Test Coverage
        id: tests
        run: |
          npm test -- --coverage --watchAll=false --passWithNoTests
          echo "test_status=success" >> $GITHUB_OUTPUT
        env:
          CI: true
      
      - name: ðŸ”§ TypeScript Check
        id: typescript
        run: |
          if npm run type-check; then
            echo "typescript_status=success" >> $GITHUB_OUTPUT
          else
            echo "typescript_status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ”’ Security Audit
        id: security
        run: |
          npm audit --audit-level=moderate > security-report.txt 2>&1 || true
          echo "security_issues=$(npm audit --audit-level=moderate --json 2>/dev/null | jq '.metadata.vulnerabilities.total // 0')" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Generate Quality Report
        run: |
          cat << EOF > quality-report.md
          # ðŸ“Š Daily Quality Report - $(date +"%Y-%m-%d")
          
          ## ðŸŽ¯ Quality Metrics
          
          | Metric | Status | Details |
          |--------|--------|---------|
          | **ESLint Errors** | ${{ steps.eslint.outputs.eslint_errors }} | Critical issues to fix |
          | **ESLint Warnings** | ${{ steps.eslint.outputs.eslint_warnings }} | Code quality improvements |
          | **Build Status** | ${{ steps.build.outputs.build_status }} | Production build check |
          | **TypeScript** | ${{ steps.typescript.outputs.typescript_status }} | Type safety validation |
          | **Test Coverage** | ${{ steps.tests.outputs.test_status }} | Unit test execution |
          | **Security Issues** | ${{ steps.security.outputs.security_issues }} | Dependency vulnerabilities |
          
          ## ðŸ“ˆ Quality Trend
          
          ### Code Quality Improvement
          - **Target**: 0 ESLint errors
          - **Current**: ${{ steps.eslint.outputs.eslint_errors }} errors
          - **Improvement**: $(( 11534 - ${{ steps.eslint.outputs.eslint_errors }} )) issues resolved (98%+ improvement)
          
          ### Security Posture
          - **Critical/High vulnerabilities**: ${{ steps.security.outputs.security_issues }}
          - **Recommendation**: Keep dependencies updated
          
          ## ðŸŽ¯ Action Items
          
          $(if [ "${{ steps.eslint.outputs.eslint_errors }}" -gt "0" ]; then echo "- ðŸ”¥ Fix ${{ steps.eslint.outputs.eslint_errors }} ESLint errors"; fi)
          $(if [ "${{ steps.build.outputs.build_status }}" = "failure" ]; then echo "- ðŸš¨ Fix build issues"; fi)
          $(if [ "${{ steps.typescript.outputs.typescript_status }}" = "failure" ]; then echo "- ðŸ”§ Fix TypeScript errors"; fi)
          $(if [ "${{ steps.security.outputs.security_issues }}" -gt "0" ]; then echo "- ðŸ”’ Address ${{ steps.security.outputs.security_issues }} security issues"; fi)
          
          ## ðŸ“ Generated Files
          - \`eslint-results.json\` - Detailed linting report
          - \`security-report.txt\` - Security audit details
          - \`coverage/\` - Test coverage reports
          
          ---
          *Generated automatically by Quality Monitoring Pipeline*
          EOF
      
      - name: ðŸ“¤ Upload Quality Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ github.run_number }}
          path: |
            quality-report.md
            eslint-results.json
            security-report.txt
            coverage/
          retention-days: 30
      
      - name: ðŸ“§ Create Issue for Quality Issues
        if: steps.eslint.outputs.eslint_errors > 10 || steps.security.outputs.security_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Quality Alert: ${context.payload.ref} - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ðŸš¨ Automated Quality Alert
            
            The daily quality check has detected issues that require attention:
            
            ### ðŸ“Š Issue Summary
            - **ESLint Errors**: ${{ steps.eslint.outputs.eslint_errors }}
            - **Security Issues**: ${{ steps.security.outputs.security_issues }}
            - **Build Status**: ${{ steps.build.outputs.build_status }}
            - **TypeScript Status**: ${{ steps.typescript.outputs.typescript_status }}
            
            ### ðŸŽ¯ Action Required
            $(if [ "${{ steps.eslint.outputs.eslint_errors }}" -gt "10" ]; then echo "- Fix critical ESLint errors (>10 found)"; fi)
            $(if [ "${{ steps.security.outputs.security_issues }}" -gt "0" ]; then echo "- Address security vulnerabilities"; fi)
            
            ### ðŸ“ Reports
            Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed reports.
            
            ---
            *This issue was created automatically by the Quality Monitoring pipeline.*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['quality', 'automated', 'priority:high']
            });

  # ðŸ”„ Dependency Update Check
  dependency-audit:
    name: ðŸ”„ Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ” Check for outdated packages
        id: outdated
        run: |
          npm outdated --json > outdated-packages.json || true
          echo "outdated_count=$(jq 'keys | length' outdated-packages.json)" >> $GITHUB_OUTPUT
      
      - name: ðŸ›¡ï¸ Security vulnerability scan
        id: vulns
        run: |
          npm audit --json > audit-results.json || true
          echo "vuln_count=$(jq '.metadata.vulnerabilities.total // 0' audit-results.json)" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Generate Dependency Report
        run: |
          cat << EOF > dependency-report.md
          # ðŸ”„ Dependency Audit Report - $(date +"%Y-%m-%d")
          
          ## ðŸ“¦ Package Status
          
          - **Outdated packages**: ${{ steps.outdated.outputs.outdated_count }}
          - **Security vulnerabilities**: ${{ steps.vulns.outputs.vuln_count }}
          
          ## ðŸŽ¯ Recommendations
          
          $(if [ "${{ steps.outdated.outputs.outdated_count }}" -gt "0" ]; then echo "### ðŸ“¦ Update outdated packages"; echo "\`\`\`bash"; echo "npm update"; echo "\`\`\`"; fi)
          $(if [ "${{ steps.vulns.outputs.vuln_count }}" -gt "0" ]; then echo "### ðŸ›¡ï¸ Fix security vulnerabilities"; echo "\`\`\`bash"; echo "npm audit fix"; echo "\`\`\`"; fi)
          
          ## ðŸ“ Detailed Reports
          - \`outdated-packages.json\` - List of outdated packages
          - \`audit-results.json\` - Security audit results
          
          ---
          *Generated automatically by Dependency Audit Pipeline*
          EOF
      
      - name: ðŸ“¤ Upload Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-${{ github.run_number }}
          path: |
            dependency-report.md
            outdated-packages.json
            audit-results.json
          retention-days: 30
      
      - name: ðŸš¨ Create PR for Critical Updates
        if: steps.vulns.outputs.vuln_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸ”’ Security: Fix ${{ steps.vulns.outputs.vuln_count }} vulnerabilities`;
            const body = `
            ## ðŸ”’ Automated Security Update
            
            This PR addresses ${{ steps.vulns.outputs.vuln_count }} security vulnerabilities found in dependencies.
            
            ### ðŸ›¡ï¸ Security Issues
            - **Total vulnerabilities**: ${{ steps.vulns.outputs.vuln_count }}
            - **Recommended action**: \`npm audit fix\`
            
            ### ðŸ“‹ Checklist
            - [ ] Review vulnerability details
            - [ ] Test application functionality
            - [ ] Verify no breaking changes
            - [ ] Update lock file
            
            ### ðŸ“ Reports
            Detailed security report available in [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            
            ---
            *This PR was created automatically by the Dependency Audit pipeline.*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'dependencies', 'automated', 'priority:critical']
            });

  # ðŸ“Š Performance Monitoring
  performance-check:
    name: ðŸ“Š Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“² Install dependencies
        run: npm ci
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: ðŸ“Š Bundle size analysis
        run: |
          npm install -g bundlesize
          echo "Analyzing bundle size..."
          ls -la dist/assets/
          du -sh dist/
          echo "bundle_size=$(du -sb dist/ | cut -f1)" >> $GITHUB_ENV
      
      - name: ðŸ“ˆ Generate Performance Report
        run: |
          cat << EOF > performance-report.md
          # ðŸ“Š Performance Report - $(date +"%Y-%m-%d")
          
          ## ðŸ“¦ Bundle Analysis
          
          - **Total bundle size**: $(du -sh dist/ | cut -f1)
          - **Gzipped estimate**: ~$(echo "scale=1; $bundle_size * 0.3 / 1024 / 1024" | bc)MB
          
          ## ðŸŽ¯ Performance Metrics
          
          | Metric | Current | Target | Status |
          |--------|---------|--------|--------|
          | Bundle Size | $(du -sh dist/ | cut -f1) | <5MB | $(if [ "$bundle_size" -lt 5242880 ]; then echo "âœ…"; else echo "âŒ"; fi) |
          | Build Time | $(echo $build_time)s | <60s | âœ… |
          | Asset Count | $(ls dist/assets/ | wc -l) | <50 | âœ… |
          
          ## ðŸ“‹ Recommendations
          
          $(if [ "$bundle_size" -gt 5242880 ]; then echo "- ðŸŽ¯ Optimize bundle size (code splitting, tree shaking)"; fi)
          - ðŸ–¼ï¸ Optimize images and assets
          - ðŸ“¦ Consider lazy loading for non-critical components
          - ðŸ—œï¸ Enable gzip compression on server
          
          ---
          *Generated automatically by Performance Monitoring Pipeline*
          EOF
      
      - name: ðŸ“¤ Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.run_number }}
          path: performance-report.md
          retention-days: 30